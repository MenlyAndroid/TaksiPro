package ru.taksi.pro.android.mvvm.vm

import android.util.Log
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import io.reactivex.rxjava3.core.Scheduler
import io.reactivex.rxjava3.disposables.CompositeDisposable
import ru.taksi.pro.android.mvvm.model.repo.ITaxiProRepository
import io.reactivex.rxjava3.kotlin.addTo
import ru.taksi.pro.android.mvvm.data.UserProperties

class RegistrationPhoneViewModel(
    private val iuSchedulers: Scheduler,
    private val repository: ITaxiProRepository
) : ViewModel() {

    private val answerLiveData = MutableLiveData<String>()
    fun getAnswerLiveData() = answerLiveData

    private val compositeDisposable = CompositeDisposable()

    fun sendPhone(phone: String) {
        repository.requestCode(phone).observeOn(iuSchedulers).subscribe({
            if (it.success == "true") {
                answerLiveData.value = "true"
            } else {
                answerLiveData.value = it.errors.tomanyrequests
            }
        }, {
            answerLiveData.value = it.message
            Log.d("!!!", "error")
        }).addTo(compositeDisposable)
    }

    fun getToken(): String? = UserProperties.instance.token

    public override fun onCleared() {
        super.onCleared()
        answerLiveData.value = ""
        compositeDisposable.dispose()
    }

}